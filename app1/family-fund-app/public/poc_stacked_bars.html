<!DOCTYPE html>
<html>
<head>
    <title>Stacked Bar POC - Trade Portfolios</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .chart-container { max-width: 900px; margin: 20px auto; }
        h2 { text-align: center; }
    </style>
</head>
<body>
    <h2>Trade Portfolio Vertical Stacked Bars</h2>

    <div class="chart-container">
        <canvas id="stackedBarChart"></canvas>
    </div>

    <script>
        // Register datalabels plugin
        Chart.register(ChartDataLabels);

        // Color palette
        const graphColors = [
            '#2563eb', '#dc2626', '#16a34a', '#d97706', '#9333ea', '#0891b2', '#db2777', '#64748b',
            '#f59e0b', '#10b981', '#6366f1', '#ec4899', '#14b8a6', '#f97316', '#4f46e5', '#059669',
        ];

        // Mock data - simulating multiple trade portfolios
        const portfolios = [
            {
                name: 'Growth 2023-01',
                items: [
                    { symbol: 'SPXL', target_share: 0.30 },
                    { symbol: 'SOXL', target_share: 0.25 },
                    { symbol: 'TECL', target_share: 0.20 },
                    { symbol: 'IAU', target_share: 0.10 },
                    { symbol: 'BTC', target_share: 0.10 },
                ],
                cash_target: 0.05
            },
            {
                name: 'Balanced 2023-06',
                items: [
                    { symbol: 'SPXL', target_share: 0.25 },
                    { symbol: 'SOXL', target_share: 0.20 },
                    { symbol: 'TECL', target_share: 0.15 },
                    { symbol: 'IAU', target_share: 0.15 },
                    { symbol: 'BTC', target_share: 0.10 },
                ],
                cash_target: 0.15
            },
            {
                name: 'Conservative 2024-01',
                items: [
                    { symbol: 'SPXL', target_share: 0.20 },
                    { symbol: 'SOXL', target_share: 0.15 },
                    { symbol: 'TECL', target_share: 0.10 },
                    { symbol: 'IAU', target_share: 0.20 },
                    { symbol: 'BTC', target_share: 0.15 },
                ],
                cash_target: 0.20
            }
        ];

        // Get all unique symbols (maintain order)
        const allSymbols = [];
        portfolios.forEach(p => {
            p.items.forEach(item => {
                if (!allSymbols.includes(item.symbol)) {
                    allSymbols.push(item.symbol);
                }
            });
        });
        allSymbols.push('Cash');

        // Create datasets - one per symbol
        const datasets = allSymbols.map((symbol, index) => {
            return {
                label: symbol,
                data: portfolios.map(p => {
                    if (symbol === 'Cash') {
                        return p.cash_target * 100;
                    }
                    const item = p.items.find(i => i.symbol === symbol);
                    return item ? item.target_share * 100 : 0;
                }),
                backgroundColor: graphColors[index % graphColors.length],
                borderColor: '#ffffff',
                borderWidth: 1,
            };
        });

        // Portfolio names as labels
        const labels = portfolios.map(p => p.name);

        new Chart(document.getElementById('stackedBarChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        stacked: true,
                        grid: { display: false }
                    },
                    y: {
                        stacked: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 11, weight: 'bold' },
                            padding: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                if (value === 0) return null;
                                return context.dataset.label + ': ' + value.toFixed(1) + '%';
                            }
                        }
                    },
                    datalabels: {
                        color: '#ffffff',
                        font: { size: 11, weight: 'bold' },
                        textShadowColor: 'rgba(0,0,0,0.5)',
                        textShadowBlur: 3,
                        formatter: function(value, context) {
                            if (value < 8) return '';
                            const symbol = context.dataset.label;
                            return symbol + ' ' + value.toFixed(0) + '%';
                        },
                        anchor: 'center',
                        align: 'center'
                    }
                }
            }
        });
    </script>
</body>
</html>
